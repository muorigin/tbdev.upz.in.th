# TBDev Torrent Tracker - SEO Optimized .htaccess
# Includes URL shortener integration and comprehensive SEO rules

# Enable Rewrite Engine
RewriteEngine On
RewriteBase /

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always append X-Frame-Options DENY

    # Prevent MIME type sniffing
    Header set X-Content-Type-Options nosniff

    # Enable XSS filtering
    Header set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy for URL Shortener
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://go.upz.in.th https://ajax.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://go.upz.in.th; frame-ancestors 'none';"

    # HSTS (HTTP Strict Transport Security) - Enable only if using HTTPS
    # Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    # Compress common file types
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On

    # Images
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/ico "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 month"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"

    # Fonts
    ExpiresByType font/truetype "access plus 1 month"
    ExpiresByType font/opentype "access plus 1 month"
    ExpiresByType application/x-font-woff "access plus 1 month"
    ExpiresByType application/font-woff2 "access plus 1 month"

    # HTML - short cache
    ExpiresByType text/html "access plus 1 hour"

    # Default
    ExpiresDefault "access plus 1 week"
</IfModule>

# SEO-Friendly URL Rewrites

# Remove trailing slashes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [R=301,L]

# Redirect www to non-www (change to your preference)
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Force HTTPS (uncomment if you have SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Block common exploit attempts
RewriteCond %{QUERY_STRING} (\|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (javascript:).*(\;) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\\|\.\./|`|=\$) [NC,OR]
RewriteCond %{QUERY_STRING} (\{0\}|\%7B0\%7D) [NC,OR]
RewriteCond %{QUERY_STRING} (127\.0\.0\.1|localhost) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block access to sensitive files
RewriteRule ^\.htaccess$ - [F,L]
RewriteRule ^\.htpasswd$ - [F,L]
RewriteRule ^\.DS_Store$ - [F,L]
RewriteRule ^phpinfo\.php$ - [F,L]
RewriteRule ^adminer\.php$ - [F,L]
RewriteRule ^wp-admin$ - [F,L]
RewriteRule ^wp-login$ - [F,L]

# Block access to backup files
RewriteRule \.(bak|backup|old|orig|original|tmp|temp)$ - [F,L]

# Block access to log files
RewriteRule \.(log|logs)$ - [F,L]

# SEO URLs for Torrent Details
RewriteRule ^torrent/([0-9]+)/?$ details.php?id=$1 [L,QSA]

# SEO URLs for User Profiles
RewriteRule ^user/([0-9]+)/?$ userdetails.php?id=$1 [L,QSA]

# SEO URLs for Categories
RewriteRule ^browse/([0-9]+)/?$ browse.php?cat=$1 [L,QSA]

# Sitemap
RewriteRule ^sitemap\.xml$ sitemap.php [L]

# Robots.txt
RewriteRule ^robots\.txt$ robots.php [L]

# RSS Feed
RewriteRule ^rss\.xml$ rss.php [L]

# API Endpoints (for URL Shortener)
RewriteRule ^api/webhook/?$ webhook.php [L]

# Error Documents
ErrorDocument 400 /400.html
ErrorDocument 401 /401.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# PHP Settings
<IfModule mod_php.c>
    php_value upload_max_filesize 100M
    php_value post_max_size 100M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
</IfModule>

# Prevent hotlinking (optional - adjust as needed)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
# RewriteRule \.(jpg|jpeg|png|gif|svg|css|js)$ - [F,L]

# Custom redirects for URL shortener (if needed)
# RewriteRule ^go/([a-zA-Z0-9]+)$ redirect.php?short=$1 [L]

# Maintenance mode (uncomment to enable)
# RewriteCond %{REQUEST_URI} !^/maintenance\.html$
# RewriteCond %{REMOTE_ADDR} !^123\.456\.789\.000$
# RewriteRule ^(.*)$ /maintenance.html [R=307,L]

# Rate limiting (basic protection against brute force)
<IfModule mod_evasive24.c>
    DOSHashTableSize 100
    DOSPageCount 5
    DOSPageInterval 1
    DOSSiteCount 50
    DOSSiteInterval 1
    DOSBlockingPeriod 600
</IfModule>

# WordPress-style URL structure (if migrating from WP)
# RewriteRule ^category/(.+)/?$ browse.php?cat=$1 [L,QSA]
# RewriteRule ^tag/(.+)/?$ search.php?search=$1 [L,QSA]

# Mobile redirects (optional)
# RewriteCond %{HTTP_USER_AGENT} "android|blackberry|googlebot-mobile|iemobile|ipad|iphone|ipod|opera mobile|palmos|webos" [NC]
# RewriteRule ^$ http://m.yourdomain.com/ [L,R=302]

# Canonical redirects for SEO
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /([^/]+/)*index\.(html|php)\ HTTP/
RewriteRule ^(([^/]+/)*)index\.(html|php)$ https://%{HTTP_HOST}/$1 [R=301,L]

# Remove query strings for static resources
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} ^$
    RewriteCond %{REQUEST_URI} \.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ [NC]
    RewriteRule ^(.*)$ $1 [E=nocache:1]
</IfModule>

# Custom 404 for SEO
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /404.html [L]

# Final fallback
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?%{QUERY_STRING} [L]